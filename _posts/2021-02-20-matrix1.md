---
layout:     post
title:      C++构建矩阵类(0)
subtitle:   设计概要
date:       2021-02-20
author:     Welt Xing
header-img: img/matrix1_header.jpg
catalog: true
categories: matrix-c
tags:
    - matrix-c
---

## 设计概要

2019年第一次接触C++，当时二维数组和线性代数中的行列式/矩阵变换几乎是同时学习（大概），当时尝试用简单的单源文件实现了一个行变换求逆矩阵的程序；之后琢磨出行列式的递归求法(逐行变换)后，编写伴随矩阵算法成功算出逆矩阵；但由于代码量的增加，`Windows`平台+`.h`文件+`.cc`文件已经不能满足需求，随即搁置。2020秋的《计算机系统基础》，教会我`Linux`平台+多源文件编译+`Makefile`+`Github`的手段管理大型项目，寒假里与`MATLAB`的接触也让我萌生重启之前工作的想法。目前[Matrix-C](https://github.com/Kaslanarian/matrix-C)已经支持如下功能：

1. 矩阵输入(`C`数组模式和`MATALB`模式)和输出；

2. 矩阵的加、减、乘和（右）除等四则运算；

3. 矩阵的行列式，逆，阶梯化；

4. 矩阵的分割，转置和翻转；

5. 求实特征值，及其对应的特征向量；

6. 几种常用的矩阵分解算法；

7. 类`MATLAB`和`Python`的交互式表达式/变量求值

8. ...

效果展示：![实现效果](/img/matrix1_1.png)

寒假临近结束，这段时间准备将知识做整理，记录第一次建工程的过程以及学习矩阵相关知识所得。

## 文件结构

`Matrix-C`的文件结构力求模块间解耦和独立，减少模块间的互相影响：

```bash
.
├── include              # 头文件文件夹
│   ├── basic.h          # 基础的数学函数，比如四舍五入(round)
│   ├── debug.h          # 用于Debug的宏：Assert, Log, ...
│   ├── expr.h           # 表达式/变量求职
│   ├── macro.h          # 宏定义，简化代码量
│   ├── math_helper.h    # 数学相关函数：求行列式，矩阵分解...
│   ├── matrix.h         # 矩阵类数据结构的定义
│   ├── operation.h      # 对矩阵可进行的操作：翻转...
│   ├── shape.h          # Shape元组类
│   └── test-program.h   # 交互式程序界面，可以进行多项测试
├── lib
│   └── libmatrix.a      # 动态链接库，《计算机系统基础》所学，可以在任意程序中使用Matrix
├── main.cc              # main函数，用于测试
├── Makefile             # Makefile
├── README.md            # Guide：可读性不高，具体内容将转移到该网站上
└── src                  # 与头文件夹中文件对应的实现
    ├── basic.cc
    ├── expr.cc
    ├── math_helper.cc
    ├── matrix.cc
    ├── operation.cc
    ├── shape.cc
    └── test-program.cc
```

## 熟悉项目编译运行

在`Linux`命令行或者是`Windows`的`GIT BASH`中输入：

```bash
git clone https://github.com/Kaslanarian/matrix-C
```

就可以获取到项目源代码，建议先将`main.cc`的`main`函数体清空以便测试；先将所有的源文件编译成可重定向文件：

```bash
g++ -c src/basic.cc 
g++ -c src/expr.cc 
g++ -c src/math_helper.cc 
g++ -c src/matrix.cc 
g++ -c src/operation.cc 
g++ -c shape.cc 
g++ -c test-program.cc
```

将这些目标文件进行链接成一个可执行文件：

```bash
# "*.o"是正则表达式语法，指该层文件夹中所有以".o"结尾的文件，将他们链接成一个可执行文件main
g++ *.o -o main 
```

运行`main`:

```bash
./main
```

无输出则编译运行成功:

![运行结果](/img/matrix1_2.png)

## 关于程序中的一些宏

程序中有很多为了保持代码简洁而使用的宏，它们都被放置在`macro.h`和`debug.h`中，接下来会进行相应的解释

### 数据类型

```cpp
#define matrix_pair std::pair<Matrix, Matrix>
```

用于存储两个矩阵的数据结构：`matrix_pair.first`是第一个矩阵，`matrix_pair.second`是第二个矩阵，你可以在[这里](https://www.cplusplus.com/reference/utility/pair/)查看`pair<T, T>`更详细的说明。

```cpp
#define matrix_tuple std::tuple<Matrix, Matrix, Matrix>
```

用于存储三个矩阵的数据结构：`std::get<0>(matrix_tuple)`能够获取第一个矩阵，`std::get<1>(matrix_tuple)`获取第二个矩阵，`std::get<2>(matrix_tuple)`获取第三个矩阵，我们在$SVD$分解和特征分解中会使用到它，你可以在[这里](https://www.cplusplus.com/reference/tuple/tuple/)查看`tuple`这个数据结构更详细的说明。

```cpp
#define vec2vec2double std::vector<std::vector<double>>
```

`matrix-c`中Matrix类的核心数据结构，表示一个以动态数组为元素的动态数组，可以理解为二位动态数组，你可以在[这里](https://www.cplusplus.com/reference/vector/vector/)了解`vector`的使用方法。

```cpp
#define vec2double std::vector<double>
```

动态数组，参考上一个宏定义。

### 功能性的宏

1. ```cpp
   #define CLEAN_BUFFER  \
       std::cin.clear(); \
       std::cin.ignore(numeric_limits<std::streamsize>::max(), '\n')
   ```

   `C++`中用于清除缓冲区，在[这里](https://welts.xyz/matrix-c/2021/02/27/buffer/)有关于缓冲区的介绍。

2. ```cpp
    #define Assert(cond, ...)                 \
        do {                                  \
            if (!(cond)) {                    \
                fflush(stdout);               \
                fprintf(stderr, "\33[1;31m"); \
                fprintf(stderr, __VA_ARGS__); \
                fprintf(stderr, "\33[0m\n");  \
                assert(cond);                 \
            }                                 \
        } while (0)
    ```

    借鉴自[NEMU](https://github.com/NJU-ProjectN/nemu)，用于在断言被触发时报告自定义信息：

    ```cpp
    double devide(double a, double b) {
       Assert(b != 0, "除数不能为0！");
       return a / b;
   }
   ```

   如果参数$b$为0，就会强行中断程序，然后输出红色的信息。

3. ```cpp
    #define panic(...) Assert(0, __VA_ARGS__)
    ```

    仍然借鉴自[NEMU](https://github.com/NJU-ProjectN/nemu)，用于无条件中断，为调试带来方便。

4. ```cpp
    #define Highlight(format, ...) \
        printf("\33[1;35m" format "\33[0m\n", ##__VA_ARGS__)
    ```

    取自[nano-lite](https://github.com/NJU-ProjectN/nanos-lite)，用于高亮输出信息，常用于重要的提示信息。

5. ```cpp
    #define TODO() panic("please implement me")
    ```

    用于填充未实现的函数，防止编译链接时出现`undefined`的问题。

- 下一篇：[Makefile的简单书写](https://welts.xyz/matrix-c/2021/02/20/matrix2/)
