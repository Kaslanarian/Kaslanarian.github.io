---
layout:     post
title:      操作系统相关
subtitle:   Lab1系统引导
date:       2021-03-11
author:     Welt Xing
header-img:
catalog:    true
tags:
    - 操作系统
---

## 前言

主要是记录操作系统实验过程，为实验报告提供副本；此外，操作系统实验课讲了很多在《计算机系统基础》中听过但没深入了解过的知识点，这里也会添加。

## 实验过程

这里省略前面计基讲过的知识（P.S. 群里计科的学生似乎没接触过Linux、git这些东西，甚至被墙了也不知道为啥，很疑惑）。

实验利用的是`qemu`模拟80386平台，运行自制的操作系统映像，这里就要提到`QEMU`，它就是一款可执行硬件虚拟化的开源托管虚拟机，用软件模拟硬件。

### 代码运行和调试

输入

```bash
qemu-system-i386 -s -S os.img
```

其中`-s`选项是在TCP的1234端口运行一个gdbserver，选项`-S`使得QEMU启动时不运行80386的CPU

这时在另一个终端中运行`gdb`，输入

```bash
(gdb)target remote localhost:1234
```

就可以连接到上述的gdbserver，接着记性一系列调试操作（gdb目前不是很熟悉，打算找个时间学一学？）.

实际上在后续的实验中，可能很难通过程序计数器添加断点，而我们生成的可执行文件也可能没有符号表信息，这时候就需要使用：

```bash
(gdb)file example    # 可执行文件
```

这样就支持使用行号、函数名等方式添加断点。

### 简单上手

我们将自制一个主引导扇区，然后用`QEMU`启动它，并输出`Hello,world!`.

```bash
mkdir OS2020
cd OS2020
touch mbr.s
```

在`mbr.s`这个汇编文本中写入：

![asm](/img/lab1/asm.png)

接下来使用gcc编译得到的mbr.s文件：

```bash
gcc -c -m32 mbr.s -o mbr.o
```

文件夹下会多一个mbr.o的文件，接下来使用ld进行链接：

```bash
ld -m elf_i386 -e start -Ttext 0x7c00 mbr.o -o mbr.elf
```

然后查看`mbr.elf`属性会发现文件过大，超过一个扇区（扇区是硬盘的最小存储单元，传统扇区大小是512字节，下图的玫红色部分就是一个扇区：）

![扇区](https://img2020.cnblogs.com/blog/73542/202004/73542-20200414225358636-1188159839.png)

> 不管是i386还是i386之前的芯片，在加电后的第一条指令都是跳转到BIOS固件进行开机自检，然后将磁盘的主引导扇区（Master Boot Record, MBR ；0号柱面，0号磁头，0号扇区对应的扇区，512字节，末尾两字节为魔数`0x55`和`0xaa`）加载到0x7c00。

所以我们尝试减少程序大小：

```bash
objcopy -S -j .text -O binary mbr.elf mbr.bin
```

我们接着需要将这个`mbr.bin`文件做成一个真正的MBR:

```bash
touch genboot.pl
```

在这个脚本语言中，我们写入以下内容：

```perl
#!/usr/bin/perl

open(SIG, $ARGV[0]) || die "open $ARGV[0]: $!";

$n = sysread(SIG, $buf, 1000);

if($n > 510){
    print STDERR "ERROR: boot block too large: $n bytes (max 510)\n";
    exit 1;
}

print STDERR "OK: boot block is $n bytes (max 510)\n";

$buf .= "\0" x (510-$n);
$buf .= "\x55\xAA";

open(SIG, ">$ARGV[0]") || die "open >$ARGV[0]: $!";
print SIG $buf;
close SIG;
```

修改权限以便于以`./filename`形式运行；

然后利用genboot.pl生成一个MBR，再次查看mbr.bin，发现其大小已经为512字节了：

```bash
/genboot.pl mbr.bin
OK: boot block is 65 bytes (max 510)
ls -al mbr.bin
-rwxr-xr-x 1 kingxu kingxu  512 2月  15 20:11 mbr.bin
```

一个MBR已经制作完成了，接下来就是查看我们的成果：

```bash
$qemu-system-i386 mbr.bin
```

实现效果如下：

![effect](/img/lab1.png)